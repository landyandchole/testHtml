
<#include "../../include/header.html">

<style type="text/css">
	.required {
      font-weight: bold;
    }

    .accept, .status {
      padding-left: 90px;
    }

    .valid {
      color: green;
    }

    .invalid {
      color: red;
    }
    span.k-tooltip {
      margin-left: 6px;
    }
</style>
<script type="text/javascript">
	var defaultOrgId = null;
	<#if orgId ??>
    	defaultOrgId = ${orgId};
	</#if>

	var templateData = null;
	var templateId = ${RequestParameters.templateId!!};
	var createType = ${RequestParameters.createType!!};
	var releaseFlag = ${RequestParameters.releaseFlag!!};
	var dataSourceId = ${RequestParameters.datasourceId!!};
    var viewModelDetail = kendo.observable({
        model:{templateId:templateId},
        createFunction: function(){
            $('#templateColumnGrid').data('kendoGrid').addRow();
            console.log(viewModelDetail.model.templateId);
        },
        saveFunction: function(){
            $('#templateColumnGrid').data('kendoGrid').saveChanges();
            setTimeout(function(){
            	loadUnifiedValidation();
                loadValueSetValidation();
				loadSqlValidation();
            },200);
        },
        queryResource: function(e) {
            $('#templateColumnGrid').data('kendoGrid').dataSource.page(1);
        }
    });
    var viewModelCustomizedValidation = kendo.observable({
        model:{templateId:templateId},
        createFunction: function(){
            //$('#customizedValidationGrid').data('kendoGrid').addRow();
        	editCustomizedValidation(null);
        },
        saveFunction: function(){
            $('#customizedValidationGrid').data('kendoGrid').saveChanges();
        },
        queryResource: function(e) {
            $('#customizedValidationGrid').data('kendoGrid').dataSource.page(1);
        }
    });
    
    var viewModelValueSetValidation = kendo.observable({
        model:{templateId:templateId},
        createFunction: function(){
            $('#valueSetValidationGrid').data('kendoGrid').addRow();
        },
        saveFunction: function(){
            $('#valueSetValidationGrid').data('kendoGrid').saveChanges();
        },
        queryResource: function(e) {
            $('#valueSetValidationGrid').data('kendoGrid').dataSource.page(1);
        }
    });
    
    var viewModelUnifiedValidation = kendo.observable({
        model:{templateId:templateId},
        createFunction: function(){
            $('#unifiedValidationGrid').data('kendoGrid').addRow();
        },
        saveFunction: function(){
            $('#unifiedValidationGrid').data('kendoGrid').saveChanges();
        },
        queryResource: function(e) {
            $('#unifiedValidationGrid').data('kendoGrid').dataSource.page(1);
        }
    });

	var viewModelSqlValidation = kendo.observable({
		model:{templateId:templateId},
		createFunction: function(){
			$('#sqlValidationGrid').data('kendoGrid').addRow();
		},
		saveFunction: function(){
			$('#sqlValidationGrid').data('kendoGrid').saveChanges();
		},
		queryResource: function(e) {
			$('#sqlValidationGrid').data('kendoGrid').dataSource.page(1);
		}
	});

	var viewModelCalculateConf = kendo.observable({
		model: {},
		createFunction: function () {
			$('#calculateConfGrid').data('kendoGrid').addRow();
		},
		saveFunction: function () {
			$('#calculateConfGrid').data('kendoGrid').saveChanges();
			$('#calculateConfGrid').data('kendoGrid').dataSource.read();
		},
		queryResource: function (e) {
			$('#calculateConfGrid').data('kendoGrid').dataSource.page(1);
		}
	});

	var viewModelOdiInvokeConf = kendo.observable({
		model: {},
		createFunction: function () {
			$('#odiInvokeConfGrid').data('kendoGrid').addRow();
		},
		saveFunction: function () {
			$('#odiInvokeConfGrid').data('kendoGrid').saveChanges();
		},
		queryResource: function (e) {
			$('#odiInvokeConfGrid').data('kendoGrid').dataSource.page(1);
		}
	});

</script>
<body>
	
	<div id = "tabstrip">
		<!-- 表头标签 -->
		<ul>
			<li id="first">模板列详情</li>
		    <li id="second">自定义验证</li>
		    <li id="third">值集验证</li>
			<li id="fourth">sql程序验证</li>
			<li id="fifth">计算程序配置</li>
			<li id="sixth">ODI接口配置</li>
			<li id="focus">focus</li>
		</ul>

		<!-- 模板列详情 templateDetail begin-->
		<div id="templateDetail">
		    <div id="upload" style="display:none">
	              <input style="border:none" type="file" name="file" id="files"/>
            </div>
            
			<div id="page-content-col">
				<div class="pull-left" id="toolbar-btn"
					style="padding-bottom: 10px;">
					<button id="addBtn" class="btn btn-primary k-grid-add" style="float: left; margin-right: 5px;"
						data-bind="click:createFunction"><@spring.message"hap.new"/></button> 
					<button class="btn btn-success k-grid-save-changes" data-bind="click:saveFunction"
						style="float: left; margin-right: 5px;"><@spring.message"hap.save"/></button> 
					<button onclick="deleteTemplateColumnData()" class="btn btn-danger"
						style="float: left;margin-right: 5px;"><@spring.message "hap.delete"/></button>					
					<button id="importColumn" hidden onclick="importColumn()" class="btn btn-success" 
						style="float:left;display:none;margin-right:5px;">导入列</button>
					<span onclick="exportExcel()"><a class="btn btn-primary k-grid-add" id="exportExcel" style="float:left;margin-right:5px;">导出数据</a></span>
				    <span onclick="importExcel()" class="btn btn-primary" style="float:left;margin-right:5px;">导入数据</span>
				</div>
				<script>
					kendo.bind($('#toolbar-btn'), viewModelDetail);
				</script>
				<div class="pull-right" id="query-form"
					style="padding-bottom: 10px;">
					<input type="text" data-role="maskedtextbox" style="float: left; width: 150px; margin-right: 5px;"
						placeholder='列文本' data-bind="value:model.name" class="k-textbox"> 
					<input type="text" data-role="maskedtextbox" style="float: left; width: 150px; margin-right: 5px;"
						placeholder='数据库表列' data-bind="value:model.dbTableCol" class="k-textbox"> 
					<span class="btn btn-primary" style="float: left; width: 70px" data-bind="click:queryResource" 
						type="submit"><@spring.message"hap.query"/></span>
					<div style="clear: both"></div>
				</div>
				<script>
					kendo.bind($('#query-form'), viewModelDetail);
				</script>
				<div style="clear: both">
					<div id="templateColumnGrid"></div>
				</div>
			</div>
		</div>
		<!-- 模板列详情 templateDetail end -->

		<!-- 自定义规则 customizedValidation begin-->
		<div id="customizedValidation">
			<div id="page-content-custom">
				<div class="pull-left" id="toolbar-btn-custom"
					style="padding-bottom: 10px;">
					<span class="btn btn-primary k-grid-add"
						style="float: left; margin-right: 5px;"
						data-bind="click:createFunction"><@spring.message
						"hap.new"/></span> <span class="btn btn-success k-grid-save-changes"
						data-bind="click:saveFunction"
						style="float: left; margin-right: 5px;"><@spring.message
						"hap.save"/></span> <span onclick="deleteCustomizedValidation()" class="btn btn-danger"
						style="float: left;"><@spring.message "hap.delete"/></span>
				</div>
				<script>
					kendo.bind($('#toolbar-btn-custom'), viewModelCustomizedValidation);
				</script>
				<div class="pull-right" id="query-form"
					style="padding-bottom: 10px;">
					<input type="text" data-role="maskedtextbox" style="float: left; width: 150px; margin-right: 5px;"
						placeholder='验证名称' data-bind="value:model.name" class="k-textbox"> 
					<input type="text" data-role="maskedtextbox" style="float: left; width: 150px; margin-right: 5px;"
						placeholder='验证描述' data-bind="value:model.description" class="k-textbox"> 
					<span class="btn btn-primary" style="float: left; width: 70px" data-bind="click:queryResource" 
						type="submit"><@spring.message"hap.query"/></span>
					<div style="clear: both"></div>
				</div>
				<script>
					kendo.bind($('#query-form'), viewModelCustomizedValidation);
				</script>							
				<div style="clear: both">
					<div id="customizedValidationGrid"></div>
				</div>
			</div>
		</div>
		<!-- 自定义规则 customizedValidation end-->
		
		<!-- 值集规则 valueSetValidation begin-->
		<div id="valueSetValidation">
			<div id="page-content-vs">
				<div class="pull-left" id="toolbar-btn-vs"
					style="padding-bottom: 10px">
					<span class="btn btn-primary k-grid-add"
						style="float: left; margin-right: 5px;"
						data-bind="click:createFunction"><@spring.message
						"hap.new"/></span>
					<span class="btn btn-success k-grid-save-changes"
						data-bind="click:saveFunction"
						style="float: left; margin-right: 5px;"><@spring.message
						"hap.save"/></span>
					<span onclick="deleteValueSetValidation()" class="btn btn-danger"
						style="float: left;"><@spring.message "hap.delete"/></span>
				</div>
				<script>
					kendo.bind($('#toolbar-btn-vs'), viewModelValueSetValidation);
				</script>							
				<div style="clear: both">
					<div id="valueSetValidationGrid"></div>
				</div>
			</div>
		</div>
		<!-- 值集规则 valueSetValidation end-->

		<!-- sql程序验证 sqlValidation begin-->
		<div id="sqlSetValidation">
			<div id="page-content-sql">
				<div class="pull-left" id="toolbar-btn-sql"
					 style="padding-bottom: 10px;">
					<span class="btn btn-primary k-grid-add"
						  style="float: left; margin-right: 5px;"
						  data-bind="click:createFunction"><@spring.message
						"hap.new"/></span> <span class="btn btn-success k-grid-save-changes"
												 data-bind="click:saveFunction"
												 style="float: left; margin-right: 5px;"><@spring.message
						"hap.save"/></span> <span onclick="deleteSqlValidation()" class="btn btn-danger"
												  style="float: left;"><@spring.message "hap.delete"/></span>
				</div>
				<script>
					kendo.bind($('#toolbar-btn-sql'), viewModelSqlValidation);
				</script>
				<div style="clear: both">
					<div id="sqlValidationGrid"></div>
				</div>
			</div>
		</div>
		<!-- sql程序验证 sqlValidation end-->

		<!-- 计算程序配置 calculateConf begin-->
		<div id="calculateConf">
		<div id="page-content-cal">
			<div id="calculateConfForm" style="display: none"></div>
			<div class="pull-left" id="toolbar-btn-cal" style="padding-bottom:10px;">
				<span class="btn btn-primary k-grid-add" onclick="editCalculateConf()" style="float:left;margin-right:5px;" >添加</span>
				<span class="btn btn-success k-grid-save-changes" data-bind="click:saveFunction" style="float:left;margin-right:5px;"><@spring.message "hap.save"/></span>
				<span onclick="deleteData()" class="btn btn-danger" style="float:left;"><@spring.message "hap.delete"/></span>
			</div>
			<script>kendo.bind($('#toolbar-btn-cal'), viewModelCalculateConf);</script>
			<div class="pull-right" id="query-form-cal" style="padding-bottom:10px;">
				<input type="text" data-role="maskedtextbox" style="float: left; width: 150px; margin-right: 5px;"
					   placeholder='计算程序名称' data-bind="value:model.calculateName" class="k-textbox">
				<span class="btn btn-primary" style="float:left;width:70px" data-bind="click:queryResource" type="submit"><@spring.message "hap.query"/></span>
				<div style="clear:both"></div>
			</div>
			<script>kendo.bind($('#query-form-cal'), viewModelCalculateConf);</script>
			<div style="clear:both">
				<div id="calculateConfGrid"></div>
			</div>
		</div>
		</div>
		<!-- 计算程序配置 calculateConf end-->

		<!-- odi接口配置 odiInvokeConf begin-->
		<div id="odiInvokeConf">
			<div id="page-content-odi">
				<div id="odiInvokeConfForm" style="display: none"></div>
				<div class="pull-left" id="toolbar-btn-odi" style="padding-bottom:10px;">
					<span class="btn btn-primary k-grid-add" data-bind="click:createFunction" style="float:left;margin-right:5px;" >添加</span>
					<span class="btn btn-success k-grid-save-changes" data-bind="click:saveFunction" style="float:left;margin-right:5px;"><@spring.message "hap.save"/></span>
					<span onclick="deleteOdiInvoke()" class="btn btn-danger" style="float:left;"><@spring.message "hap.delete"/></span>
				</div>
				<script>kendo.bind($('#toolbar-btn-odi'), viewModelOdiInvokeConf);</script>
				<div style="clear:both">
					<div id="odiInvokeConfGrid"></div>
				</div>
			</div>
		</div>
		<!-- odi接口配置 odiInvokeConf end-->

		<!-- 一致性规则 unified validation begin-->
		<div id="unifiedValidation">
			<div id="page-content">
				<div class="pull-left" id="toolbar-btn"
					style="padding-bottom: 10px;">
					<span class="btn btn-primary k-grid-add"
						style="float: left; margin-right: 5px;"
						data-bind="click:createFunction"><@spring.message
						"hap.new"/></span> <span class="btn btn-success k-grid-save-changes"
						data-bind="click:saveFunction"
						style="float: left; margin-right: 5px;"><@spring.message
						"hap.save"/></span> <span onclick="deleteUnifiedValidationData()" class="btn btn-danger"
						style="float: left;"><@spring.message "hap.delete"/></span>
				</div>
				<script>
					kendo.bind($('#toolbar-btn'), viewModelUnifiedValidation);
				</script>							
				<div style="clear: both">
					<div id="unifiedValidationGrid"></div>
				</div>
			</div>
		</div>
		<!-- 一致性规则 unified validation end-->

	</div>
	
	<div id="customizedValidationForm"></div>
	<div id="importColumnPanel"></div>
	
	<script type="text/javascript">
            kendo.bind($('#templateDetail'),viewModelDetail);
            kendo.bind($('#customizedValidation'),viewModelCustomizedValidation);
            kendo.bind($('#valueSetValidation'),viewModelValueSetValidation);
            kendo.bind($('#unifiedValidation'),viewModelUnifiedValidation);
			kendo.bind($('#sqlSetValidation'),viewModelSqlValidation);
			kendo.bind($('#calculateConf'),viewModelCalculateConf);
			kendo.bind($('#odiInvokeConf'),viewModelOdiInvokeConf);
            var tabToActivate = $("#first");
            $("#tabstrip").kendoTabStrip({
            	 show:function(e){
                     if(e.item.id == "first"){
                         Hap.autoResizeGrid("#templateColumnGrid");
                     }else if(e.item.id=="second"){
                         Hap.autoResizeGrid("#customizedValidationGrid");
                     }else if(e.item.id == "third"){
                    	 Hap.autoResizeGrid("#valueSetValidationGrid");
                     }else if(e.item.id=="fourth"){
                    	 Hap.autoResizeGrid("#sqlValidationGrid");
                     }else if(e.item.id=="fifth"){
						 Hap.autoResizeGrid("#calculateConfGrid");
					 }else if(e.item.id=="sixth"){
						 Hap.autoResizeGrid("#odiInvokeConfGrid");
					 }

                 }
            }).data("kendoTabStrip").activateTab(tabToActivate);
	</script>
	
	<!-- 模板列详情 template detail begin-->
	<script type="text/javascript">

        //使一个可输入的框强制获得焦点，防止发布模板后IE下的筛选条件不可输入值的问题
        $("#focus").focus();
        $("#focus").hide();

		var existTable = true;
		if( releaseFlag == 1) {
			//模版列
			$("#toolbar-btn").css("display","none");
		}
		
		if( createType == 1 )  {
			//表
			$('#importColumn').show();
			$('#addBtn').css("display","none");
		}else if(createType == 2){
			//视图
			$('#importColumn').show();
			$('#addBtn').css("display","none");
		} else{
			//新建的表
			isExistTable();
		}
		
		function exportExcel(){
			$('#exportExcel').attr('href',"${base.contextPath}/hdm/templateColumn/exportExcel?templateId="+templateId);
		}
		
		function importExcel(){
			//定义文件上传
			var upload = $("#files").data('kendoUpload');
			if(upload){
				$(".k-upload-files.k-reset").find("li").remove();
			}else {			
			$("#files").kendoUpload({
		        async: {
		            saveUrl: "${base.contextPath}/hdm/templateColumn/importExcel?${_csrf.parameterName}=${_csrf.token}&templateId="+templateId,
		            autoUpload: false,
		            multiple: false
		        },
				validation:{
					allowedExtensions:[".xlsx"],
				},
	            success: function(e){
	            	//关闭上传页面
	                var messages=JSON.parse(e.XMLHttpRequest.responseText);
	            	if(messages.status==1){
	                	alert(messages.message);
	                }else{
	                	$('#templateColumnGrid').data('kendoGrid').dataSource.read();
	                }
	                $("#upload").data("kendoWindow").close();
	                
	            }
		    });}
			$("#upload").kendoWindow({
		         width: "500px",
		         height:"200px",
		         title: '文件上传',
		         actions: [
		                "Pin",
		                "Minimize",
		                "Maximize",
		                "Close"
		         ],
		         modal:true,
		         visible:false
		   });
		   var uploadFile = $("#upload").data("kendoWindow");
		   uploadFile.center().open();
		}
		
		function isExistTable(){
	    	$.ajax({
	            url: "${base.contextPath}/hdm/templateColumn/isExistTable?templateId="+templateId,
	            type: 'POST',
	            dataType: 'json',
	            success: function (data) {    
	            	if(data == 0 ) {
	            		existTable = false;
	            	}
	            	else if(data == 1) {

	            	}
	            	else {

	            	}
	            }       
	        });
	    }
	    
	var templateColumnDictionaryData = null;
	$.ajax({
        url: "${base.contextPath}/hdm/templateColumnDictionary/getAllDictionary",
        type: 'GET',
        dataType: 'json',
        success: function (data) {    
        	templateColumnDictionaryData = data;
         }
    });
	
		$("#importColumnPanel").kendoWindow({
		        width: "95%",
		        height:"80%",
		        title: '模板详情',
		        actions: [
		               "Pin",
		               "Minimize",
		               "Maximize",
		               "Close"
		        ],
		        modal:true,
		        visible:false,
		        iframe:true
		});
		function importColumn(){					
			var importColumnPanel =  $("#importColumnPanel").data("kendoWindow");
			importColumnPanel.refresh('importColumnPanel.html?templateId='+templateId);
			importColumnPanel.center().open();
		}

	    $('#query-form input').keydown(function (e) {
		    if (e.keyCode == 13) {
		        e.target.blur();
		        viewModelDetail.queryResource(e);
		    }
		});
		$('#query-form-cal input').keydown(function (e) {
			if (e.keyCode == 13) {
				e.target.blur();
				viewModelCalculateConf.queryResource(e);
			}
		});
	
		function toggleAllDetail(e) {
			var view = dataSourceDetail.view();
		    var checked = e.target.checked;
		    for (var i = 0; i < view.length; i++) {
		        view[i].set("checked", checked);
		    }
		}
	
		function deleteTemplateColumnData() {        
			Hap.deleteGridSelection({
		     	grid:$('#templateColumnGrid')
		    });
			setTimeout(function(){
				loadUnifiedValidation();
		        loadValueSetValidation();
				loadSqlValidation();
		    },200);
		}

	        var BaseUrl = "${base.contextPath}/hdm/templateColumn/",
	            dataSourceDetail = new kendo.data.DataSource({
	                transport: {
	                    read:  {
	                        url: BaseUrl + "query?sortname=seq&sortorder=desc",
	                        type : "POST",
	                        dataType: "json"
	                    },
	                    update: {
	                        url: BaseUrl + "submit",
	                        type : "POST" ,
	                        contentType: "application/json"
	                    },
	                    destroy: {
	                        url: BaseUrl + "delete",
	                        type : "POST" ,
	                        contentType: "application/json"
	                    },
	                    create: {
	                        url: BaseUrl + "submit",
	                        type : "POST" ,
	                        contentType: "application/json"
	                    },
	                    parameterMap: function(options, type) {
	                    	 if (type !== "read" && options.models) {
	                             var datas = Hap.prepareSubmitParameter(options, type)
	                             return kendo.stringify(datas);
	                         } else if (type === "read") {
	                             return Hap.prepareQueryParameter(viewModelDetail.model.toJSON(), options)
	                         } 
	                    }
	                },
	                batch: true,
	                serverPaging : true,
	                pageSize: 50,

	                schema: {
	                    data:'rows',
	                    total:'total',
	                    model: {
	                    	id: "templateColumnId",
	                        fields: {
	                        	name: {validation: {required: true},defaultValue:null},
	                            templateId:{defaultValue: templateId},
	                            dbTableCol:{type: "string",editable:false, validation: { pattern:"^[a-zA-Z][a-zA-Z0-9_]*$"},defaultValue:null},
								dbViewCol:{type: "string",editable:false, validation: { pattern:"^[a-zA-Z][a-zA-Z0-9_]*$"},defaultValue:null},
	                            isPk:{
	                                defaultValue:"否"
	                            },	                            
	                            dataType:{
	                                defaultValue:"numeric"
	                            },
	                            maxLength:{
	                            	type: "number",
	                            	defaultValue: ""
	                            },
	                            minLength:{
	                            	type: "number",
	                            	defaultValue: ""
	                            },
	                            intPrecision:{
	                            	type: "number",
	                            	defaultValue: "11"
	                            },
	                            decimalPrecision:{
	                            	type: "number",
	                            	defaultValue: "0"
	                            },
								readonly:{
									type:"string",
									defaultValue:"否"
								},
	                            isEmpty:{
									type:"string",
	                            	defaultValue:"否"
	                            },
	                            isOnly:{
									type:"string",
	                            	defaultValue:"否"
	                            },
	                            seq:{
	                                defaultValue: 10
	                            }
	                        },
	                        editable:function(field){
	                        	if( releaseFlag == 1 ) return false;
	                        	if( createType == 1 || createType == 2)
	                        		return true;
	                        	else
	                        		return true;
	  	               		}
	                    }
	                },
	                requestEnd: function(e) {
	                	templateData = e.response;	                    
	                }
	            });
	
	        $("#templateColumnGrid").kendoGrid({
	        	dataSource: dataSourceDetail,
	        	height     : '100%',
	            resizable  : true,
	            scrollable : true,
	            navigatable: false,
	            autoResize:true,
                selectable : 'multiple, rowbox',
	            pageable: {
	                pageSizes:[50, 100, 200, 500],
	                refresh:true,
	                buttonCount:5
	            },
                sortable:true,
	            columns: [
	                {
	                    field: "name",
	                    title: "列文本",
	                    width: "100px",
	                    template        : function (dataItem) {
	                        return dataItem['name'] || ''
	                    },
	                    editor          : function (container, options) {
	                        $('<input name="' + options.field + '"/>')
	                                .appendTo(container)
	                                .kendoLov($.extend(<@lov "LOV_DICTIONARY"/>, {
	                                    textField: 'name',
	                                    model    : options.model,
	                                    query: function (e) {
                                            e.param['orgId'] = defaultOrgId;
                                        }, 
	                                    select: function(e){
	                                    	options.model.set('dbTableCol',e.item.dbTableCol);
                                            options.model.set('isPk',e.item.isPk);
                                            options.model.set('dataType',e.item.dataType);
                                            options.model.set('maxLength',e.item.maxLength);
                                            options.model.set('minLength',e.item.minLength);
                                            options.model.set('intPrecision',e.item.intPrecision);
                                            options.model.set('decimalPrecision',e.item.decimalPrecision);
											options.model.set('readonly',e.item.readonly);
                                            options.model.set('isEmpty',e.item.isEmpty);
                                            options.model.set('isOnly',e.item.isOnly);
                                           } 
	                                })
	                                );
	                    }
	                },
	                {
	                    field: "dbTableCol",
	                    title: "数据库表列",
	                    width: "140px",
	                    attributes: {
	                    	style: "text-align: left"
	                    }
	                },
					{
						field: "dbViewCol",
						title: "数据库视图列",
						width: "140px",
						attributes: {
							style: "text-align: left"
						}
					},
	                {
	                    field: "isPk",
	                    title: "主键标志",
	                    width: "70px",
	                    attributes: {
	                        style: "text-align: left"
	                	},
	                    template: function (dataItem) {
	                        if (dataItem.isPk == '是') {
	                            return "是";
	                        } else {
	                            return "否";
	                        }
	                    },
	                    editor: function (container, options) {
	                        var dropDownList = $('<input required data-bind="value: isPk"/>')
	                            .appendTo(container)
	                            .kendoDropDownList({
	                                dataTextField: "name",
	                                dataValueField: "id",
	                                dataSource: [
	                                    {id: "是", name: "是"},
	                                    {id: "否", name: "否"}
	                                ]
	                            });
	                    }
	                },
	                {
	                    field: "dataType",
	                    title: "数据类型",
	                    width: "100px",
	                    attributes: {
	                        style: "text-align: left"
	                    },
	                    template: function (dataItem) {
	                        if (dataItem.dataType == 'numeric') {
	                            return "数字类型";
	                        } else if(dataItem.dataType == 'text'){
	                            return "文本类型";
	                        } else if(dataItem.dataType == 'date'){
	                            return "日期类型";
	                        }
	                    },
	                    editor: function (container, options) {
	                        var dropDownList = $('<input required data-bind="value: dataType" />')
	                            .appendTo(container)
	                            .kendoDropDownList({
	                                dataTextField: "name",
	                                dataValueField: "id",
	                                dataSource: [
	                                    {id: "numeric", name: "数字类型"},
	                                    {id: "text", name: "文本类型"},
	                                    {id: "date", name: "日期类型"}
	                                ],
	                                select: function(e){
	                                	if( e.item.context.innerText == "数字类型" ){
	                                		options.model.set('maxLength','');
	                                        options.model.set('minLength','');
	                                        options.model.set('intPrecision','11');
	                                        options.model.set('decimalPrecision','0');
	                                    }else if( e.item.context.innerText == "文本类型" ){
	                                		options.model.set('maxLength','255');
	                                        options.model.set('minLength','0');
	                                        options.model.set('intPrecision','');
	                                        options.model.set('decimalPrecision','');
	                                    }else if( e.item.context.innerText == "日期类型" ){
	                                		options.model.set('maxLength','');
	                                        options.model.set('minLength','');
	                                        options.model.set('intPrecision','');
	                                        options.model.set('decimalPrecision','');
	                                    }
                                     } 
	                            });
	                    }
	                },
	                {
	                    field: "maxLength",
	                    title: "最大长度",
	                    width: "70px"
	                },
	                {
	                    field: "minLength",
	                    title: "最小长度",
	                    width: "70px",
						hidden: true
	                },
	                {
	                    field: "intPrecision",
	                    title: "整数精度",
	                    width: "70px"                     
	                },
	                {
	                    field: "decimalPrecision",
	                    title: "小数精度",
	                    width: "70px"                     
	                },
					{
						field: "readonly",
						title: "是否只读",
						width: "70px",
						attributes: {
							style: "text-align: left"
						},
						template: function (dataItem) {
							if (dataItem.readonly == '是') {
								return "是";
							} else {
								return "否";
							}
						},
						editor: function (container, options) {
							var dropDownList = $('<input required data-bind="value: readonly"/>')
									.appendTo(container)
									.kendoDropDownList({
										dataTextField: "name",
										dataValueField: "id",
										dataSource: [
											{id: "是", name: "是"},
											{id: "否", name: "否"}
										]
									});
						}
					},
	                {
	                    field: "isEmpty",
	                    title: "是否必输",
	                    width: "70px",
	                    attributes: {
	                        style: "text-align: left"
	                	},
	                    template: function (dataItem) {
	                        if (dataItem.isEmpty == '是') {
	                            return "是";
	                        } else {
	                            return "否";
	                        }
	                    },
	                    editor: function (container, options) {
	                        var dropDownList = $('<input required data-bind="value: isEmpty"/>')
	                            .appendTo(container)
	                            .kendoDropDownList({
	                                dataTextField: "name",
	                                dataValueField: "id",
	                                dataSource: [
	                                    {id: "是", name: "是"},
	                                    {id: "否", name: "否"}
	                                ]
	                            });
	                    }
	                },
	                {
	                    field: "isOnly",
	                    title: "是否唯一",
	                    width: "70px",
	                    attributes: {
	                        style: "text-align: left"
	                	},
	                    template: function (dataItem) {
	                        if (dataItem.isOnly == '是') {
	                            return "是";
	                        } else {
	                            return "否";
	                        }
	                    },
	                    editor: function (container, options) {
	                        var dropDownList = $('<input required data-bind="value: isOnly"/>')
	                            .appendTo(container)
	                            .kendoDropDownList({
	                                dataTextField: "name",
	                                dataValueField: "id",
	                                dataSource: [
	                                    {id: "是", name: "是"},
	                                    {id: "否", name: "否"}
	                                ]
	                            });
	                    }
	                },
	                {
	                    field: "seq",
	                    title: "序号",
	                    width: "80px",
	                    attributes: {
	                        style: "text-align: left"
	                    }
	                },	              
	               ],
	                editable: true,
	                dataBound  : function () {
	                    var view = this.dataSource.view();
	                    this.items().each(function (index, row) {
	                        kendo.bind(row, view[index]);
	                    });
	                }
	        });		
	</script>   
    <!-- 模板列详情 template detail end-->
   
    <!-- 自定义验证 customized validation begin-->
    <script type="text/javascript">

		if( releaseFlag == 1 || createType == 2) {
			//自定义校验
			$("#toolbar-btn-custom").css("display","none");
		}
	
		function toggleAllCustomized(e) {
		    var view = dataSourceCustomizedValidation.view();
		    var checked = e.target.checked;
		    for (var i = 0; i < view.length; i++) {
		        view[i].set("checked", checked);
		    }
		}
		
		function deleteCustomizedValidation() {
			Hap.deleteGridSelection({
				grid:$('#customizedValidationGrid')
			});
		}
		
		var BaseUrl = "${base.contextPath}/hdm/customizedValidation/",
        dataSourceCustomizedValidation = new kendo.data.DataSource({
            transport: {
                read:  {
                    url: BaseUrl + "query",
                    type : "POST",
                    dataType: "json"
                },
                update: {
                    url: BaseUrl + "submit",
                    type : "POST" ,
                    contentType: "application/json"
                },
                destroy: {
                    url: BaseUrl + "delete",
                    type : "POST" ,
                    contentType: "application/json"
                },
                create: {
                    url: BaseUrl + "submit",
                    type : "POST" ,
                    contentType: "application/json"
                },
                parameterMap: function(options, type) {
                	 if (type !== "read" && options.models) {
                         var datas = Hap.prepareSubmitParameter(options, type)
                         return kendo.stringify(datas);
                     } else if (type === "read") {
                         return Hap.prepareQueryParameter(viewModelCustomizedValidation.model.toJSON(), options)
                     } 
                }
            },
            batch: true,
            serverPaging : true,
            pageSize: 50,
            schema: {
                data:'rows',
                total:'total',
                model: {
                	id: "customizedValidationId",
                    fields: {
                    	templateId:{defaultValue:templateId},
                    	name: {type:"string"},
                    	description:{type:"string"},
                    	program:{type:"string"},
                    	status:{
							type:"number",
							editable:true
                    	},
                        version: {
                            editable: false,
                            defaultValue: 0
                        }
                    },
					editable:function(field){
						//此设置会覆盖列中设置的editable值
						if(field == "status"){
							return false;
						}

						if( releaseFlag == 1 ) return false;
						else
							return true;
					}
				}
            }
        });
        
        $("#customizedValidationGrid").kendoGrid({
        	dataSource: dataSourceCustomizedValidation,
        	height     : '100%',
            resizable  : true,
            scrollable : true,
            navigatable: false,
            selectable : 'multiple, rowbox',
            pageable: {
                pageSizes:[50, 100, 200, 500],
                refresh:true,
                buttonCount:5
            },
            columns: [
                {
                    field: "name",
                    title: "验证名称",
                    width: "150px"
                },
                {
                    field: "description",
                    title: "验证描述",
                    width: "150px"	                  
                }, 
                {
                    field: "status",
                    title: "验证状态",
                    width: "150px",
                    template:'<input type="checkbox" #= status==1 ? \'checked="checked"\' : "" # data-field="status" class="chkbx" #= releaseFlag == 1 ? \'disabled="true"\' : "" # />'
                },
                {
                    title: "操作",
                    width: "150px",
                    headerAttributes: {
                        "class": "table-header-cell",
                        style  : "text-align: center"
                    },
                    template : function (rowdata) {
                        if (!!rowdata.id) {
							return '<a href="#" onclick="editCustomizedValidation(' + rowdata.id + ')" disabled="true">编辑</a>&nbsp;&nbsp;&nbsp;<a href="#" onclick="checkProgram(' + rowdata.id + ')">检验程序</a>'
						}else{
							return ''
						}
                    },
                }
               ],
                editable: true,
                dataBound  : function () {
                    var view = this.dataSource.view();
                    this.items().each(function (index, row) {
                        kendo.bind(row, view[index]);
                    });
                }
        });		
        
        //处理grid中的选择框
        $("#customizedValidationGrid").on("change", "input.chkbx", function (e) {
            var target = $(e.target), grid = $("#customizedValidationGrid").data("kendoGrid"),
                    dataItem = grid.dataItem(target.closest("tr"));
            dataItem.set(target.data('field'), this.checked ? 1 : 0);         
        });
        
        $("#customizedValidationForm").kendoWindow({
            /* width: "900px",
            height:"450px", */
            width: "80%",
            height:"85%",
            title: '编辑',
            actions: [
                   "Pin",
                   "Minimize",
                   "Maximize",
                   "Close"
            ],
            modal:true,
            visible:false,
            iframe:true 
                      
      });
        
        function editCustomizedValidation(customizedValidationId){
        	var templateDetails =  $("#customizedValidationForm").data("kendoWindow");
        	if( customizedValidationId )
            	templateDetails.refresh('customizedValidationForm.html?customizedValidationId='+customizedValidationId+'&releaseFlag='+releaseFlag);
        	else
        		templateDetails.refresh('customizedValidationForm.html?releaseFlag='+releaseFlag);
        	templateDetails.center().open();
        }
        
        function checkProgram(customizedValidationId){
        	$.ajax({
                type   : 'GET',
                url    : '${base.contextPath}/hdm/customizedValidation/checkProgram?customizedValidationId='+customizedValidationId+'&templateId='+templateId,
                dataType : "json",
                contentType : "application/json",
                success: function (data) {
                	var message;
                	if( data.success ) {
                		message = "语法正确";
                	}
                	else{
                		message = data.message;
                	}
                	kendo.ui.showInfoDialog({
    		        	title:$l('hap.tip.info'),
    		            message: message
    		        })
                }
            }); 
        }
    </script>
	 <!-- 自定义验证 customized validation end-->
	 
    <!-- 值集验证 valueSet validation begin-->
    <script type="text/javascript">

		if( releaseFlag == 1 || createType == 2) {
			//值集校验
			$("#toolbar-btn-vs").css("display","none");
		}
	
		function toggleAllValueSet(e) {			
		    var view = valueSetValidationDataSource.view();
		    var checked = e.target.checked;
		    for (var i = 0; i < view.length; i++) {
		        view[i].set("checked", checked);
		    }
		}
		
		function deleteValueSetValidation() {
			Hap.deleteGridSelection({
				grid:$('#valueSetValidationGrid')
			});
		}
		
		var valueSets = null;
		$.ajax({
	        url: "${base.contextPath}/hdm/dimension/getAll",
	        type: 'GET',
	        dataType: 'json',
	        success: function (data) {    
	        	valueSets = data;
	        }
		});
		
		var BaseUrl = "${base.contextPath}/hdm/valueSetValidation/",
    	valueSetValidationDataSource = new kendo.data.DataSource({
            transport: {
                read:  {
                    url: BaseUrl + "query",
                    type : "POST",
                    dataType: "json"
                },
                update: {
                    url: BaseUrl + "submit",
                    type : "POST" ,
                    contentType: "application/json"
                },
                destroy: {
                    url: BaseUrl + "delete",
                    type : "POST" ,
                    contentType: "application/json"
                },
                create: {
                    url: BaseUrl + "submit",
                    type : "POST" ,
                    contentType: "application/json"
                },
                parameterMap: function(options, type) {
                	 if (type !== "read" && options.models) {
                         var datas = Hap.prepareSubmitParameter(options, type)
                         return kendo.stringify(datas);
                     } else if (type === "read") {
                         return Hap.prepareQueryParameter(viewModelValueSetValidation.model.toJSON(), options)
                     } 
                }
            },
            batch: true,
            serverPaging : true,
            pageSize: 50,
            schema: {
                data:'rows',
                total:'total',
                model: {
                	id: "id",
                    fields: {
                    	templateId:{defaultValue: templateId},
                    	templateColumnId: {},
                    	dimensionId: {},
                    	dimensionValueField:{},
						dimensionMappingField:{}
                    }
                },
				editable:function(field){
					if( releaseFlag == 1 ) return false;
					else
						return true;
				}
            }
        });
		
		function loadValueSetValidation() {
		var allColumn = null;      
		$.ajax({
	        url: "${base.contextPath}/hdm/templateColumn/getByTemplateId?templateId="+templateId,
	        type: 'GET',
	        dataType: 'json',
	        success: function (data) {    
	        	allColumn = data;
	        	dimensionValueFieldDataSource = [
	                {fieldName: "维值别名", fieldValue: "name"},
	                {fieldName: "维值描述", fieldValue: "description"},
	                {fieldName: "维值编码", fieldValue: "value"}
                ];
	        	
	
	        $("#valueSetValidationGrid").kendoGrid({
	        	dataSource: valueSetValidationDataSource,
	        	height     : '100%',
	            resizable  : true,
	            scrollable : true,
	            navigatable: false,
	            autoResize:true,
                selectable : 'multiple, rowbox',
	            pageable: {
	                pageSizes:[50, 100, 200, 500],
	                refresh:true,
	                buttonCount:5
	            },
	            columns: [
	                {
	                    field: "templateColumnId",
	                    title: "验证列",
	                    width: "150px",
	                    template: function(dataItem){   
	                    	
	                  	   if( !dataItem.templateColumnId)
	                     		return "";     	                  	   
	                  	   var v = dataItem.templateColumnId;                             	   
	                         $.each(allColumn, function (i, n) {                                      	 
	                             if (n.templateColumnId == v ) {	                            	
	                                 v = n.name;                             
	                                 return false;
	                             }
	                         })
	                         return v;   
	                      },
	                      editor  : function (container, options) {           
	                          $('<input name="' + options.field + '"/>')
	                                  .appendTo(container)
	                                  .kendoDropDownList({
	                                  	  valuePrimitive: true,
	                                      dataTextField : "name",
	                                      dataValueField: "templateColumnId",                                    
	                                      dataSource    : allColumn                                                                                              
	                                  });
	                      }
	                },
	                {
	                    field: "dimensionId",
	                    title: "验证的值集",
	                    width: "150px",
	                    template: function(dataItem){  	                
	                 	   if( !dataItem.dimensionId)
	                    		return "无"; 
	                 	   var v = dataItem.dimensionId;
	                        $.each(valueSets, function (i, n) {                                  	 
	                            if (n.dimensionId == v ) {
	                                v = n.name;                             
	                                return false;
	                            }
	                        })                                    
	                        return v;   
	                     },
	                     editor  : function (container, options) {           
	                         $('<input name="' + options.field + '"/>')
	                                 .appendTo(container)
	                                 .kendoDropDownList({
	                                 	 valuePrimitive: true,
	                                     dataTextField : "name",
	                                     dataValueField: "dimensionId",
	                                     dataSource    : valueSets	                                                                              
	                                 });                        
	                     }
	                },
	                {
	                    field: "dimensionValueField",
	                    title: "验证的维度源字段",
	                    width: "150px",
	                    template: function(dataItem){  
	                    	if( !dataItem.dimensionValueField)
	                    		return "无"; 
	                 	   var v = dataItem.dimensionValueField;
	                        $.each(dimensionValueFieldDataSource, function (i, n) {
	                            if (n.fieldValue == v ) {
	                                v = n.fieldName;                             
	                                return false;
	                            }
	                        })                                    
	                        return v;
	                     },
	                     editor  : function (container, options) {  
	                    	 
	                         $('<input name="' + options.field + '"/>')
	                                 .appendTo(container)
	                                 .kendoDropDownList({
	                                 	 valuePrimitive: true,
	                                     dataTextField : "fieldName",
	                                     dataValueField: "fieldValue",                                    
	                                     dataSource    : dimensionValueFieldDataSource
	                                 });
	                     }
	                },
					{
						field: "dimensionMappingField",
						title: "映射的维度源字段",
						width: "150px",
						template: function(dataItem){
							if( !dataItem.dimensionMappingField)
								return "无";
							var v = dataItem.dimensionMappingField;
							$.each(dimensionValueFieldDataSource, function (i, n) {
								if (n.fieldValue == v ) {
									v = n.fieldName;
									return false;
								}
							})
							return v;
						},
						editor  : function (container, options) {

							$('<input name="' + options.field + '"/>')
									.appendTo(container)
									.kendoDropDownList({
										valuePrimitive: true,
										dataTextField : "fieldName",
										dataValueField: "fieldValue",
										dataSource    : dimensionValueFieldDataSource
									});
						}
					}
	               ],
	                editable: true,
	                dataBound  : function () {
	                    var view = this.dataSource.view();
	                    this.items().each(function (index, row) {
	                        kendo.bind(row, view[index]);
	                    });
	                }
	        });
	        }       
	    });	  
		}    
        loadValueSetValidation();
    </script>
    <!-- 值集验证 valueSet validation end-->

	<!-- sql程序验证 sql validation begin-->
	<script type="text/javascript">

		if( releaseFlag == 1 || createType == 2) {
			//sql校验
			$("#toolbar-btn-sql").css("display","none");
		}

		function toggleAllValueSet(e) {
			var view = sqlValidationDataSource.view();
			var checked = e.target.checked;
			for (var i = 0; i < view.length; i++) {
				view[i].set("checked", checked);
			}
		}

		function deleteSqlValidation() {
			Hap.deleteGridSelection({
				grid:$('#sqlValidationGrid')
			});
		}

		var validations = null;
		$.ajax({
			url: "${base.contextPath}/dcm/validation/getAll",
			type: 'GET',
			dataType: 'json',
			success: function (data) {
				validations = data;
			}
		});

		var BaseUrl = "${base.contextPath}/hdm/tempValidation",
				sqlValidationDataSource = new kendo.data.DataSource({
					transport: {
						read:  {
							url: BaseUrl + "/query",
							type : "POST",
							dataType: "json"
						},
						update: {
							url: BaseUrl + "/submit",
							type : "POST" ,
							contentType: "application/json"
						},
						destroy: {
							url: BaseUrl + "/remove",
							type : "POST" ,
							contentType: "application/json"
						},
						create: {
							url: BaseUrl + "/submit",
							type : "POST" ,
							contentType: "application/json"
						},
						parameterMap: function(options, type) {
							if (type !== "read" && options.models) {
								var datas = Hap.prepareSubmitParameter(options, type)
								return kendo.stringify(datas);
							} else if (type === "read") {
								return Hap.prepareQueryParameter(viewModelSqlValidation.model.toJSON(), options)
							}
						}
					},
					batch: true,
					serverPaging : true,
					pageSize: 50,
					schema: {
						data:'rows',
						total:'total',
						model: {
							id: "id",
							fields: {
								templateId:{defaultValue: templateId},
								columnId: {},
								validationId:{},
								seq:{},
								params:{}
							}
						}
					}
				});

		function loadSqlValidation() {
			var allColumn = null;
			$.ajax({
				url: "${base.contextPath}/hdm/templateColumn/getByTemplateId?templateId=" + templateId,
				type: 'GET',
				dataType: 'json',
				success: function (data) {
					allColumn = data;
					$("#sqlValidationGrid").kendoGrid({
						dataSource: sqlValidationDataSource,
						height: '100%',
						resizable: true,
						scrollable: true,
						navigatable: false,
						autoResize: true,
						selectable: 'multiple, rowbox',
						pageable: {
							pageSizes: [50, 100, 200, 500],
							refresh: true,
							buttonCount: 5
						},
						columns: [
							{
								field: "columnId",
								title: "验证列",
								width: "150px",
								template: function (dataItem) {

									if (!dataItem.columnId)
										return "";
									var v = dataItem.columnId;
									$.each(allColumn, function (i, n) {
										if (n.templateColumnId == v) {
											v = n.name;
											return false;
										}
									})
									return v;
								},
								editor: function (container, options) {
									$('<input name="' + options.field + '"/>')
											.appendTo(container)
											.kendoDropDownList({
												valuePrimitive: true,
												dataTextField: "name",
												dataValueField: "templateColumnId",
												dataSource: allColumn
											});
								}
							},
							{
								field: "validationId",
								title: "校验程序名",
								width: "150px",
								template: function (dataItem) {
									if (!dataItem.validationId)
										return "无";
									var v = dataItem.validationId;
									$.each(validations, function (i, n) {
										if (n.validationId == v) {
											v = n.validationName;
											return false;
										}
									})
									return v;
								},
								editor: function (container, options) {
									$('<input name="' + options.field + '"/>')
											.appendTo(container)
											.kendoDropDownList({
												valuePrimitive: true,
												dataTextField: "validationName",
												dataValueField: "validationId",
												dataSource: validations
											});
								}
							},
							{
								field: "seq",
								title: "序号",
								width: "150px",
								attributes: {
									style: "text-align: left"
								}
							},
							{
								field: "params",
								title: "参数",
								width: "150px"
							}
						],
						editable: function(field) {
							if (releaseFlag == 1) return false;
						},
						dataBound: function () {
							var view = this.dataSource.view();
							this.items().each(function (index, row) {
								kendo.bind(row, view[index]);
							});
						}
					});
				}
			});
		}
		loadSqlValidation();
	</script>
	<!-- sql程序验证 sql validation end-->

	<!-- 计算程序配置 calculateConf begin-->
	<script type="text/javascript">
		if( releaseFlag == 1 || createType == 2) {
			$("#toolbar-btn-cal").css("display","none");
		}
		var BaseUrl = "${base.contextPath}/hdm/templateCalculateLinkTemp/",
				dataSource = new kendo.data.DataSource({
					transport: {
						read: {
							url: BaseUrl + "query?templateId="+templateId,
							type: "POST",
							dataType: "json"
						},
						update: {
							url: BaseUrl + "submit",
							type: "POST",
							contentType: "application/json"
						},
						destroy: {
							url: BaseUrl + "remove",
							type: "POST",
							contentType: "application/json"
						},
						create: {
							url: BaseUrl + "submit",
							type: "POST",
							contentType: "application/json"
						},
						parameterMap: function (options, type) {
							if (type !== "read" && options.models) {
								var datas = Hap.prepareSubmitParameter(options, type)
								return kendo.stringify(datas);
							} else if (type === "read") {
								return Hap.prepareQueryParameter(viewModelCalculateConf.model.toJSON(), options)
							}
						}
					},
					batch: true,
					serverPaging: true,
					pageSize: 10,
					sort:{
						field:'seq',
						dir: "asc"
					},
					schema: {
						data: 'rows',
						total: 'total',
						model: {
							id: "id",
							fields: {
								id:{type:"number"},
								calculateId:{type:"number"},
								calculateName:{type:"string"},
								calculateCode:{type:"string"},
								description:{type:"string"},
								runStyle:{type:"string"},
								seq:{type:"number"},
								params:{type:"string"},
							}
						}
					}
				});

		$("#calculateConfGrid").kendoGrid({
			dataSource: dataSource,
			height: '100%',
			resizable: true,
			scrollable: true,
			navigatable: false,
			selectable: 'multiple, rowbox',
			pageable: {
				pageSizes: [5, 10, 20, 50],
				refresh: true,
				buttonCount: 5
			},
			sortable:true,
			columns: [
				{
					field: "id",
					title: 'id',
					width: 120,
					hidden:true,
				},
				{
					field: "calculateId",
					title: 'calculateId',
					width: 120,
					hidden:true,
				},
				{
					field: "calculateName",
					title: '计算程序名称',
					width: 120
				},
				{
					field: "calculateCode",
					title: '计算程序编码',
					width: 120
				},
				{
					field: "description",
					title: '描述',
					width: 120
				},
				{
					field: "runStyle",
					title: '运行方式',
					width: 120,
					attributes: {
						style: "text-align: left"
					},
					template: function (dataItem) {
						if (dataItem.runStyle == '保存即运行') {
							return "保存即运行";
						} else if(dataItem.runStyle == '手动运行') {
							return "手动运行";
						}
						else{
							return '';
						}
					},
					editor: function (container, options) {
						var dropDownList = $('<input required data-bind="value: runStyle"/>')
								.appendTo(container)
								.kendoDropDownList({
									dataTextField: "name",
									dataValueField: "id",
									dataSource: [
										{id: "保存即运行", name: "保存即运行"},
										{id: "手动运行", name: "手动运行"}
									]
								});
					}
				},
				{
					field: "seq",
					title: '序号',
					width: 120
				},
				{
					field: "params",
					title: "参数",
					width: "150px"
				}
			],
			editable: true
		});

		function deleteData() {

			Hap.deleteGridSelection({
				grid: $('#calculateConfGrid')
			});

		}

		//编辑弹窗函数
		editCalculateConf = function () {
			var calculateConf =  $("#calculateConfForm").kendoWindow({
				actions: ["Close"],
				width  : 600,
				height : 420,
				title  : '编辑',
				visible: false,
				iframe : true,
				modal  : true,
				content: '../templateCalculate/calculateConfForm.html?templateId='+templateId ,
				close:function(e){
					$("#calculateConfGrid").data("kendoGrid").dataSource.page(1);
				}
			}).data("kendoWindow");
			calculateConf.center().open();
		};

		Hap.autoResizeGrid("#calculateConfGrid");


	</script>
	<!-- 计算程序配置 calculateConf end-->

	<!-- odi接口配置 odiInvokeConf begin-->
	<script type="text/javascript">

		if( releaseFlag == 1 || createType == 2) {

			$("#toolbar-btn-odi").css("display","none");
		}


		function deleteOdiInvoke() {
			Hap.deleteGridSelection({
				grid:$('#odiInvokeConfGrid')
			});
		}

		var odiInvokes = null;
		$.ajax({
			url: "${base.contextPath}/hdm/scene/getAll",
			type: 'GET',
			dataType: 'json',
			success: function (data) {
				odiInvokes = data;
			}
		});

		var BaseUrl = "${base.contextPath}/hdm/templateScene",
				odiInvokeDataSource = new kendo.data.DataSource({
					transport: {
						read:  {
							url: BaseUrl + "/query?templateId="+templateId,
							type : "POST",
							dataType: "json"
						},
						update: {
							url: BaseUrl + "/submit",
							type : "POST" ,
							contentType: "application/json"
						},
						destroy: {
							url: BaseUrl + "/remove",
							type : "POST" ,
							contentType: "application/json"
						},
						create: {
							url: BaseUrl + "/submit",
							type : "POST" ,
							contentType: "application/json"
						},
						parameterMap: function(options, type) {
							if (type !== "read" && options.models) {
								var datas = Hap.prepareSubmitParameter(options, type)
								return kendo.stringify(datas);
							} else if (type === "read") {
								return Hap.prepareQueryParameter(viewModelOdiInvokeConf.model.toJSON(), options)
							}
						}
					},
					batch: true,
					serverPaging : true,
					pageSize: 50,
					schema: {
						data:'rows',
						total:'total',
						model: {
							id: "id",
							fields: {
								templateId:{defaultValue: templateId},
								sceneId:{},
								projectName:{validation: {required: true}},
								customArgs:{},
								seq:{}
							}
						}
					}
				});

		$("#odiInvokeConfGrid").kendoGrid({
			dataSource: odiInvokeDataSource,
			height: '100%',
			resizable: true,
			scrollable: true,
			navigatable: false,
			autoResize: true,
			selectable: 'multiple, rowbox',
			pageable: {
				pageSizes: [50, 100, 200, 500],
				refresh: true,
				buttonCount: 5
			},
			columns: [
				{
					field: "sceneId",
					title: "ODI场景别名",
					width: "150px",
					template: function (dataItem) {
						if (!dataItem.sceneId)
							return "无";
						var v = dataItem.sceneId;
						$.each(odiInvokes, function (i, n) {
							if (n.sceneId == v) {
								v = n.sceneAlias;
								return false;
							}
						})
						return v;
					},
					editor: function (container, options) {
						$('<input name="' + options.field + '"/>')
								.appendTo(container)
								.kendoDropDownList({
									valuePrimitive: true,
									dataTextField: "sceneAlias",
									dataValueField: "sceneId",
									dataSource: odiInvokes
								});
					}
				},
				{
					field:"projectName",
					title:"项目名称",
					width:120
				},
				{
					field:"customArgs",
					title:"自定义参数",
					width:120
				},
				{
					field: "seq",
					title: "序号",
					width: "150px",
					attributes: {
						style: "text-align: left"
					}
				}
			],
			editable: function(field) {
				if (releaseFlag == 1) return false;
			},
			dataBound: function () {
				var view = this.dataSource.view();
				this.items().each(function (index, row) {
					kendo.bind(row, view[index]);
				});
			}
		});

	</script>
	<!-- odi接口配置 odiInvokeConf end-->

    <!-- 一致性验证unified validation begin-->
    <script type="text/javascript">
	
		function toggleAllUnified(e) {
		    var view = unifiedValidationDataSource.view();
		    var checked = e.target.checked;
		    for (var i = 0; i < view.length; i++) {
		        view[i].set("checked", checked);
		    }
		}
		
		function deleteUnifiedValidationData() {
			Hap.deleteGridSelection({
		     	grid:$('#unifiedValidationGrid')
		    });
		}
		
		var BaseUrl = "${base.contextPath}/hdm/unifiedValidation/",
    	unifiedValidationDataSource = new kendo.data.DataSource({
            transport: {
                read:  {
                    url: BaseUrl + "query",
                    type : "POST",
                    dataType: "json"
                },
                update: {
                    url: BaseUrl + "submit",
                    type : "POST" ,
                    contentType: "application/json"
                },
                destroy: {
                    url: BaseUrl + "delete",
                    type : "POST" ,
                    contentType: "application/json"
                },
                create: {
                    url: BaseUrl + "submit",
                    type : "POST" ,
                    contentType: "application/json"
                },
                parameterMap: function(options, type) {
                	 if (type !== "read" && options.models) {
                         var datas = Hap.prepareSubmitParameter(options, type);
                         for(var i = 0; i < datas.length; i++ )	                            	 
                         	datas[i].templateColumnIds = datas[i].templateColumnIds.join(','); 
                         return kendo.stringify(datas);
                     } else if (type === "read") {
                         return Hap.prepareQueryParameter(viewModelUnifiedValidation.model.toJSON(), options)
                     } 
                }
            },
            batch: true,
            serverPaging : true,
            pageSize: 50,
            schema: {
                data:'rows',
                total:'total',
                model: {
                	id: "id",
                    fields: {
                    	templateId:{defaultValue: templateId},
                    	templateColumnIds: {},
                    	vaildTemplateColumnId: {}                                    
                    }
                }
            }
        });
		
		function loadUnifiedValidation() {
		var allColumn = null;      
		$.ajax({
	        url: "${base.contextPath}/hdm/templateColumn/getByTemplateId?templateId="+templateId,
	        type: 'GET',
	        dataType: 'json',
	        success: function (data) {    
	        	allColumn = data;
	        	
	        	
	
	        $("#unifiedValidationGrid").kendoGrid({
	        	dataSource: unifiedValidationDataSource,
	        	height     : '100%',
	            resizable  : true,
	            scrollable : true,
	            navigatable: false,
	            autoResize:true,
                selectable : 'multiple, rowbox',
	            pageable: {
	                pageSizes:[50, 100, 200, 500],
	                refresh:true,
	                buttonCount:5
	            },
	            columns: [
	                /* {
	                            headerTemplate: '<input type="checkbox" onclick="toggleAllUnified(event)" tabindex="-1"/>',
	                            template: '<input class="checkbox hCheckbox" type="checkbox" data-bind="checked: checked" tabindex="-1"/>',
	                            width:30       
	                }, */
	                {
	                    field: "templateColumnIds",
	                    title: "列文本",
	                    width: "150px",	                   
	                    template: function(dataItem){	 	                    	
	                    	 if( !dataItem.templateColumnIds)
	                    		return "无"; 	                    	 
	                    	 var templateColumnIds = dataItem.templateColumnIds;
	                    	 if( typeof dataItem.templateColumnIds == "string" ){
	                    		 templateColumnIds = [];
	                    		 var arr = dataItem.templateColumnIds.split(',');
	                    		 for(var i = 0; i < arr.length; i++ ){	                    			
	                    			 templateColumnIds.push(arr[i]);
	                    		 }
	                    		 dataItem.templateColumnIds = templateColumnIds;
	                    	 }
	                    	 var v = [];	                    	
	                    	 $.each(allColumn, function (i, n) {  
	                    		 for(var idx = 0; idx < templateColumnIds.length; idx++ ) {		                    			
		                            if (n.templateColumnId == templateColumnIds[idx] ) {		                            	
		                                v.push(n.name); 		                            
		                            }
	                    		 }
		                     });  
	                    	//dataItem.templateColumnIds = templateColumnIds.join(',');
	                    	return v.join(',');               
	                    },  
	                    editor  : function (container, options) {  
	                    	  $("<select multiple='multiple' data-bind='value : templateColumnIds'/>")
	                    	  .appendTo(container).kendoMultiSelect({
	                    		  	valuePrimitive: true,
	                    		  	dataTextField : "name",
                                  	dataValueField: "templateColumnId",                                  
	                    	        dataSource: allColumn
	                    	    });	                    	  
	                      }
	                },
	                {
	                    field: "vaildTemplateColumnId",
	                    title: "验证的列文本",
	                    width: "150px",
	                    template: function(dataItem){  
	                 	   if( !dataItem.vaildTemplateColumnId)
	                    		return "无"; 
	                 	   var v = dataItem.vaildTemplateColumnId;                             	   
	                        $.each(allColumn, function (i, n) {                                  	 
	                            if (n.templateColumnId == v ) {
	                                v = n.name;                             
	                                return false;
	                            }
	                        })                                    
	                        return v;   
	                     },
	                     editor  : function (container, options) {           
	                         $('<input name="' + options.field + '"/>')
	                                 .appendTo(container)
	                                 .kendoDropDownList({
	                                 	 valuePrimitive: true,
	                                     dataTextField : "name",
	                                     dataValueField: "templateColumnId",	                           
	                                     dataSource    : allColumn                                          
	                                 });
	                     }
	                }                         
	               ],
	                editable: true,
	                dataBound  : function () {
	                    var view = this.dataSource.view();
	                    this.items().each(function (index, row) {
	                        kendo.bind(row, view[index]);
	                    });
	                }
	        });
	        }       
	    });
		}   
		loadUnifiedValidation();

    </script>
	 <!-- 一致性验证unified validation end-->


</body>